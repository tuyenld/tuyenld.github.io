---
layout: post
featured-img: git
title: Git stuff
categories:
- linux
comments: true
---
## Common usages
### 1. config
```bash
git config --global user.email "ldtuyen@example.com"
git config --global user.name "ldtuyen Ubuntu"
git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
# =>	git lg to see better output
```

### 2. Usage
```bash
# >> Edit commit pushed (ONLY USE ON PERSONAL GITHUB)
# ERROR: > hint: Updates were rejected because the tip of your current branch is behind
# SOL: This should only be the case if you're amending an already-pushed commit. 
# https://stackoverflow.com/a/18589008/5407195

git add FILES
git commit --amend --no-edit
git push -f origin master

# >> resolve merge conflicts in Git?
# https://stackoverflow.com/a/163659/5407195

# Edit and reslove conflict
git mergetool

# Add new commit
git commit

# >> Git show certain commit
git show <revhash> 
# show full commit
git show --pretty=fuller {ID}

# >> View the change history of a file using Git versioning

gitk --follow [filename]
# also work with deleted file
git log --follow -p -- file

# Hiển thị sự khác nhau của 1 file ở 2 branch khác nhau
git diff mybranch yourbranch -- myfile.c

# Kiểm tra thay đổi với từng loại file *.c, *.h
git diff -- '*.c' '*.h'

# >> rebase
# pull when there are some changes on remote
git pull --rebase
# rebase in progress; onto 9c168a5
git rebase --abort


# >> Git clean all untracked file and directory

# -d: Remove untracked directories in addition to untracked files. 
#   If an untracked directory is managed by a different Git repository, 
#   it is not removed by default. 
#   Use -f option twice if you really want to remove such a directory.
# -f, --force: If the Git configuration variable clean.
#    requireForce is not set to false, git clean will refuse to run 
#    unless given -f, -n or -i.
# -x: Don’t use the standard ignore rules read from .gitignore (per directory) 
#    and $GIT_DIR/info/exclude, but do still use the ignore rules given with -e options. 
#    This allows removing all untracked files, including build products. 
#    This can be used (possibly in conjunction with git reset) 
#    to create a pristine working directory to test a clean build.
git clean -xdf
git clean -f
git clean -df
git reset --hard origin/branch
git checkout .

# >> Gerrit add reviewer
ssh -p 29418 git.example.com gerrit set-reviewers \
-a someone@example.com \
-a whoever@example.com \
<shaID>
```

### Amend OLDER commit than HEAD on Gerrit

https://stackoverflow.com/a/8825163/5407195

### How do I update a GitHub forked repository?
```bash
# https://stackoverflow.com/a/7244456/14558037
# Add the remote, call it "upstream":

git remote add upstream https://github.com/whoever/whatever.git

# Fetch all the branches of that remote into remote-tracking branches,
# such as upstream/main or upstream/master:
git fetch upstream

# Make sure that you're on your main branch:
git checkout main #e.g master

# Rewrite your main branch so that any commits of yours that
# aren't already in upstream/main are replayed on top of that
# other branch:
git rebase upstream/main  #e.g master

# You only need to use the -f the first time after you've rebased.
git push -f origin main
```

### Delete branch

```bash
# https://stackoverflow.com/a/2003515

# Delete remote branch
git push -d <remote_name> <branch_name>
# Note that in most cases the remote name is origin. 
# In such a case you'll have to use the command like so.
# $ git push -d origin <branch_name>

# Delete brach locally
git branch -d <branch_name>


```
## Rewriting history

Included `git commit --amend`, `git rebase` and `git reflog`

### `git commit --amend`
Change the last commit.

- It lets you combine **staged changes** with the previous commit instead of creating an entirely new commit.
- It replaces the most recent commit **entirely**, it does not just alter it.
  - **Don’t amend public commits**
  - Amended commits are actually entirely new commits and the previous commit will no longer be on your current branch. This is a confusing situation for developers to be in and it’s complicated to recover from.
  - If a commit has no reference, it will be discarded soon.

![git-amend](/images/posts/git/git-amend.svg)

**Change most recent Git commit message**

```bash
git commit --amend -m "an updated commit message"
```

**Changing committed files**
```bash
# Edit hello.py and main.py 
git add hello.py 
git commit -m "add hello.py"
git log
# commit 9bc6ee171f9fdfff63d31cf3356214198d516e9b
# Author: Some One <someone@gmail.com>
# Date:   Fri Apr 9 02:45:56 2021 -0400

#     add hello

# Realize you forgot to add the changes from main.py 
git add main.py 
git commit --amend --no-edit
git log
# commit e951c3175126ce61a579fc4c2689d9bf4a16cb5f
# Author: Some One <someone@gmail.com>
# Date:   Fri Apr 9 02:45:56 2021 -0400

#     add hello
```
> Commit ID was changed, so the older commit ID will be removed if there is no reference to it.

**Changing older or multiple commits**

### `git rebase`

```
a -- b -- c                      <-- Master
           \
            d -- e               <-- Branch1
           \
            d -- e -- f' -- g'   <-- Branch2
```

```bash
git checkout Branch2
git rebase Branch1
```

```
a -- b -- c                  <-- Master
           \
            d -- e -- f -- g <-- Branch1
```

## Giới thiệu 
![](/images/posts/git/git-gioi-thieu.svg)

Trong đó:
- `Working Directory` là những file vật lý lưu trữ trên ổ cứng của bạn.
  - Có thể xem đây là mặt đất
- `Stage` chứa những file chuẩn bị cho commit lần tiếp theo.
  - Có thể  xem đây là phòng chờ trước khi lên máy bay.
  - Debug trạng thái của Stage bằng lệnh `git ls-files -s`
- `History` là lịch sử thay đổi file đã được lưu trữ bởi git.
  - Ok, chúng ta đã lên hết máy bay. Lúc nào `git push` thì máy bay sẽ đưa chúng ta lên Sao Hỏa.

`3. git checkout file`  chỉ có tác dụng khi chưa `git add`, nếu đã add rồi thì phải `git reset` trước.  
`4. git reset file` dùng để **undo** `git add file`  

Dưới đây là vòng đời của file khi làm việc với git.

![](/images/posts/git/file-lifeCycle.svg)

Mỗi file sẽ nằm ở 1 trong 4 trạng thái: `Untracked`, `Unmodified`, `Modified` và `Staged`

Trước khi bắt đầu vào chức năng các lệnh cơ bản của git, chúng ta cùng làm quen với các ký hiệu, quy ước sẽ sử dụng trong tài liệu này:

![](/images/posts/git/git-convention.png)

Trong đó:
- `Commit ID` được thể hiện bằng 5 ký tự, màu xanh và chúng trỏ đến `parent` của mình (ví dụ `ed489` trỏ đến cha của mình là `da985`)
- `Branch` trỏ đến 1 `commit ID` cụ thể, có màu cam (ví dụ: `stable`, `main`)
- `Branch hiện tại` được thể hiện bởi `HEAD` (chính là `main`)

## Git checkout
Thường dùng ở 3 dạng sau:
a. `git checkout <commit> <file>`
b. `git checkout <commit>`
c. `git checkout <branch>`

a. `git checkout <commit> <file>`
- Sao chép tệp tin được chỉ định đến [Stage] và [Working] space
- Chỉ có tệp tin bị thay đổi mà không ảnh hưởng đến `branch` hiện tại
- Commit ở đây có thể là `ID <Mã SHA1>` hoặc `HEAD, HEAD~1` (lùi lại 1 commit so với con trỏ HEAD)

Ví dụ:
![](/images/posts/git/git-checkout-commit-file.png)

b. `git checkout <branch>`
- HEAD sẽ được chuyển tới nhánh đó, [Stage] và [Working] được thiết lập để khớp với nội dung của "commit" đó
- Bất kỳ tập tin nào tồn tại trong commit `a47c3` sẽ được sao chép
- Bất kỳ tập tin nào tồn tại trong commit `ed489` nhưng không tồn tại trong `a47c3` sẽ bị xóa bỏ
- Bất kỳ tập tin nào không tồn tại trong cả hai commit `ed489, a47c3` sẽ được bỏ qua

![](/images/posts/git/git-checkout-branch.png)

c. `git checkout commit`
- commit có thể là HEAD, HEAD~, HEAD~2, master, master~2
- Khi đó chúng ta sẽ chuyển đến nhánh vô danh (kể cả trường hợp checkout đến đúng commit của HEAD hoặc master) --> đây gọi là `detached HEAD`
- Tất cả những commit trên nhánh vô danh này sẽ bị xóa bỏ nếu không được tạo nhánh mới

Ví dụ:
![git checkout main ~3](/images/posts/git/git-checkout-main-3.png)

Nếu bạn đang ở `b325c` và tiến hành sửa đổi file sau đó commit:
![git commit no-name](/images/posts/git/git-commit-no-name.png)

Sau khi commit mới `2eecb` được tạo thành, bạn muốn quay lại nhánh `main` để làm việc.
![git checkout main from no-name](/images/posts/git/git-checkout-main-from-no-name.png)
Khi đó bạn sẽ thấy rằng, `2eecb` không được trỏ đến. Do đó commit này sẽ bị xóa trong tương lai. Vậy có cách nào giữ lại commit này không.

Giải pháp là tạo ra nhánh mới, ngay sau khi bạn commit `2eecb` bằng lệnh: `git checkout -b new`
![git checkout new](/images/posts/git/git-checkout-new.png)

## Git reset
- Chuyển nhánh hiện tại đến một vị trí khác (`git checkout` chỉ chuyển con trỏ `HEAD`)
- 3 commit `ed489`, `da985` và `c10b9` sau khi `git reset` sẽ bị treo lủng lẳng (`dangling commits`) vì không có cái gì trỏ đến nó cả. Sau khi git thực hiện quá trình dọn rác `garbage collection` những commit này sẽ bị xóa. 
- Do đó `git reset` chỉ được khuyên dùng **trên máy bạn** để bạn thử nghiệm, đừng thực hiện trên **public repo**. Khi đó những người làm cùng với bạn sẽ rất khó hiểu chuyện gì đang xảy ra. Khi cần thiết reset commit, hãy sử dụng `git revert`

![git reset](/images/posts/git/git-reset.png)

Git reset thường được dùng với 3 tham số  truyền vào sau:
- `mixed`: đây là tham số mặc định, `git reset` = `git reset --mixed HEAD`
  - [working directory] được giữ nguyên
  - [stage] và [history] bị reset
  - --> Nghĩa là những thay đổi mà chưa commit sẽ được giữ lại
- `soft`: chỉ có [history] bị reset, [stage] và [working directory] được giữ nguyên
- `hard`: tất cả [working directory], [stage] và [history] đều bị reset
![git reset soft-hard-mixed](/images/posts/git/git-reset-mixed-hard-soft.svg)

### Ví dụ về `git reset --mixed`
```bash
$ echo 'new file content' > new_file
$ git add new_file
$ echo 'append content' >> reset_lifecycle_file
$ git add reset_lifecycle_file
$ git status
On branch master
Changes to be committed:
    (use "git reset HEAD ..." to unstage)

new file: new_file
modified: reset_lifecycle_file

$ git ls-files -s
100644 8e66654a5477b1bf4765946147c49509a431f963 0 new_file
100644 7ab362db063f9e9426901092c00a3394b4bec53d 0 reset_lifecycle_file

$ git reset --mixed
$ git status
On branch master
Changes not staged for commit:
    (use "git add ..." to update what will be committed)
    (use "git checkout -- ..." to discard changes in working directory)

modified: reset_lifecycle_file

Untracked files:
    (use "git add ..." to include in what will be committed)

new_file


no changes added to commit (use "git add" and/or "git commit -a")
$ git ls-files -s
100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file

# The Staging Index has been reset and 
# the pending changes have been moved into the Working Directory. 
# Compare this to the --hard reset case where 
# the Staging Index was reset and the Working Directory was reset as well, 
# losing these updates.
```
### Ví dụ về `git reset --soft`

```bash
$ git log
commit ffa7492c729b10176b4e0f6ae78e64dce34d8fdd (HEAD -> master)
Author: tuyenld <someone@mail.com>
Date:   Sat Apr 24 15:39:23 2021 +0700

    add new_file

$ git add new_file_stage working_dir 
$ git commit -m "add new file and working dir"
[master bce65e0] add new file and working dir
 2 files changed, 2 insertions(+)
 create mode 100644 new_file_stage
 create mode 100644 working_dir
$ 
$ echo 333 > new_file

$ git reset --soft HEAD~
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD <file>..." to unstage)

	new file:   new_file_stage
	new file:   working_dir

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   new_file

$ cat new_file
333
$ 

# Ở commit HEAD~ thì có 2 file changed được added new_file_stage và working_dir
# Sau khi git reset --soft thì: new_file_stage và working_dir đã nằm trong Stage
# vì git reset --soft không thay đổi gì [Stage] và [Working Directory] cả
```
### Ví dụ về `git reset --hard`
```bash
$ echo 'new file content' > new_file
$ git add new_file
$ echo 'changed content' >> reset_lifecycle_file
$ git status
On branch master
Changes to be committed:
   (use "git reset HEAD ..." to unstage)

new file: new_file

Changes not staged for commit:
   (use "git add ..." to update what will be committed)
   (use "git checkout -- ..." to discard changes in working directory)

modified: reset_lifecycle_file



$ git ls-files -s
100644 8e66654a5477b1bf4765946147c49509a431f963 0 new_file
100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file

$ git reset --hard
HEAD is now at dc67808 update content of reset_lifecycle_file
$ git status
On branch master
nothing to commit, working tree clean
$ git ls-files -s
100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file

# Staging Index has been reset to a point before new_file was added. 
# Our modifications to reset_lifecycle_file and the addition of new_file have been destroyed. 
# This data loss cannot be undone, this is critical to take note of.
```

## Git revert
![git revert and reset](/images/posts/git/git-revert-vs-reset.svg)
Câu lệnh: `git revert <commit>`  
- Undo commit bằng 1 commit mới. Nó sẽ "revert" tất cả thay đổi mà \<commit\> **tạo ra**.
- `git revert ` không làm thay đổi history như `git reset`, do đó nó được sử dụng với **public repo**. Xin nhắc lại, `git reset` chỉ nên sử dụng với **private repo**.
- `git revert` làm thay đổi [working directory], do đó nên lưu lại những thay đổi này bằng `git stash` trước khi thực hiện `git revert`


## Nguồn tài liệu tham khảo
- [A Visual Git Reference](https://marklodato.github.io/visual-git-guide/index-en.html)
- [Git Basics - Recording Changes to the Repository](https://git-scm.com/book/en/v2/Git-Basics-Recording-Changes-to-the-Repository)
- [Become a git guru](https://www.atlassian.com/git/tutorials)
- [git.logikum.hu](git.logikum.hu)
- [Version control with Git](http://software-carpentry.org/)


# Gitlab
- [Code review and collaboration with Merge Requests](https://docs.gitlab.com/ee/university/training/topics/merge_requests.html)
- [New merge request from your local environment](https://docs.gitlab.com/ee/user/project/merge_requests/creating_merge_requests.html)
- [Code Review](https://github.com/thoughtbot/guides/tree/main/code-review)




